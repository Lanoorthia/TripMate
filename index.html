const FEEDBACK_ENDPOINT = "https://<your-endpoint>";
const FEEDBACK_METHOD = "POST"; // ‡∏´‡∏£‡∏∑‡∏≠ "GET" ‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ

<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TripMate ‚Äî Prototype (Single File)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}.line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}</style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="inline-flex w-5 h-5 items-center justify-center text-blue-600">üìç</span>
        <div class="font-bold">TripMate</div>
      </div>
      <div class="flex items-center gap-2">
        <div id="locStatusEl" class="text-xs text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</div>
        <button id="openFeedback" class="ml-2 border rounded-2xl px-3 py-1.5 text-xs">‡∏™‡πà‡∏á‡∏ü‡∏µ‡∏î‡πÅ‡∏ö‡πá‡∏Å</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-3xl mx-auto px-4 py-4 pb-28">
    <!-- DISCOVER -->
    <section id="page-discover" class="space-y-4">
      <div class="flex items-center gap-2">
        <div class="relative flex-1">
          <input id="discoverSearchInput" class="w-full border rounded-xl pl-9 pr-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... (‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á)">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">üîé</span>
        </div>
        <button id="openCreatePost" class="bg-blue-600 hover:bg-blue-700 text-white rounded-2xl px-4 py-2">+ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
      </div>
      <div class="flex gap-3 overflow-x-auto no-scrollbar" id="promoBanners"></div>
      <div class="flex items-center gap-2 text-sm text-gray-700">üî• ‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
      <div class="flex gap-2 overflow-x-auto no-scrollbar" id="topTags"></div>
      <div class="flex items-center gap-2 mt-2">
        <button id="modePostsBtn" class="bg-blue-600 text-white rounded-2xl px-3 py-1.5 text-sm">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button id="modeTilesBtn" class="border border-gray-300 rounded-2xl px-3 py-1.5 text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</button>
      </div>
      <div id="discoverContent" class="grid grid-cols-1 gap-3"></div>
    </section>

    <!-- SEARCH -->
    <section id="page-search" class="hidden space-y-3">
      <div class="flex items-center gap-2">
        <div class="relative flex-1">
          <input id="searchInput" class="w-full border rounded-xl pl-9 pr-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£...">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">üîé</span>
        </div>
        <button id="applySearchBtn" class="border border-gray-300 rounded-2xl px-3 py-2">‚öôÔ∏è ‡∏Å‡∏£‡∏≠‡∏á</button>
      </div>
      <div id="categoryChips" class="flex gap-2 overflow-x-auto no-scrollbar py-1"></div>
      <div id="provinceChips" class="flex gap-2 overflow-x-auto no-scrollbar py-1"></div>
      <div class="flex items-center gap-3 text-sm text-gray-600"><span>üß≠ ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</span> <span id="distVal">80</span> ‡∏Å‡∏°.</div>
      <input id="distSlider" type="range" min="5" max="200" step="5" value="80" class="w-full accent-blue-600" />
      <div id="locInfo" class="text-xs text-gray-500"></div>
      <div id="searchResults" class="grid grid-cols-1 gap-3"></div>
    </section>

    <!-- GROUPS -->
    <section id="page-groups" class="hidden space-y-4"><div id="groupContainer"></div></section>

    <!-- REWARDS -->
    <section id="page-rewards" class="hidden space-y-4">
      <div class="bg-white border rounded-2xl p-4 flex items-center justify-between">
        <div><div class="text-lg font-semibold">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div><div id="pointsEl" class="text-2xl font-bold text-blue-600">0 pts</div><div id="badgesEl" class="mt-1 text-sm text-gray-500">‡πÅ‡∏ö‡∏î‡∏à‡πå: -</div></div>
        <div class="text-4xl">üèÖ</div>
      </div>
      <div id="rewardsList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
    </section>

    <!-- PROFILE -->
    <section id="page-profile" class="hidden space-y-4">
      <div class="bg-white border rounded-2xl p-4 flex items-center justify-between">
        <div><div class="text-xl font-semibold"><span id="userNameEl">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</span> <span id="userHandleEl" class="text-sm text-gray-500">@handle</span></div>
          <div id="userMetaEl" class="text-sm text-gray-500">‡∏£‡∏∞‡∏î‡∏±‡∏ö: - ¬∑ ‡πÅ‡∏ï‡πâ‡∏°: - ¬∑ ‡πÅ‡∏ö‡∏î‡∏à‡πå: -</div></div>
        <div class="text-4xl">üë§</div>
      </div>
      <div><div class="font-semibold mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div><div id="myReviews" class="space-y-2"></div></div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 inset-x-0 bg-white border-t z-40">
    <div class="max-w-3xl mx-auto grid grid-cols-5 text-sm">
      <button data-tab="discover" class="py-3 flex flex-col items-center text-blue-600">üè†<span class="text-xs">‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö</span></button>
      <button data-tab="search" class="py-3 flex flex-col items-center text-gray-600">üîé<span class="text-xs">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span></button>
      <button data-tab="groups" class="py-3 flex flex-col items-center text-gray-600">üë•<span class="text-xs">‡∏Å‡∏•‡∏∏‡πà‡∏°</span></button>
      <button data-tab="rewards" class="py-3 flex flex-col items-center text-gray-600">‚≠ê<span class="text-xs">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</span></button>
      <button data-tab="profile" class="py-3 flex flex-col items-center text-gray-600">üë§<span class="text-xs">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></button>
    </div>
  </nav>

  <!-- One-click Detail Modal -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black/50 z-50 p-4">
    <div class="bg-white w-full max-w-2xl mx-auto mt-[10vh] rounded-2xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="text-lg font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö</div>
        <button id="closeDetail" class="px-3 py-1.5 rounded-xl hover:bg-gray-100">‚úï</button>
      </div>
      <div id="detailContent" class="space-y-4"></div>
    </div>
  </div>

  <!-- Create Post Modal -->
  <div id="createModal" class="hidden fixed inset-0 bg-black/50 z-50 p-4">
    <div class="bg-white w-full max-w-lg mx-auto mt-[10vh] rounded-2xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="text-lg font-semibold">‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</div>
        <button id="closeCreate" class="px-3 py-1.5 rounded-xl hover:bg-gray-100">‚úï</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
          <select id="createPlace" class="w-full border rounded-md p-2 mt-1"></select>
        </div>
        <div>
          <label class="text-sm">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="createRateLabel">5</span> ‡∏î‡∏≤‡∏ß</label>
          <input id="createRate" type="range" min="1" max="5" step="1" value="5" class="w-full accent-blue-600" />
        </div>
        <div>
          <label class="text-sm">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</label>
          <textarea id="createText" rows="4" class="w-full border rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡πÄ‡∏•‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"></textarea>
        </div>
        <div id="verifyHint" class="text-sm text-gray-500">* ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Verified</div>
        <div class="flex items-center justify-end gap-2">
          <button id="cancelCreate" class="border border-gray-300 rounded-2xl px-4 py-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="submitCreate" class="bg-blue-600 hover:bg-blue-700 text-white rounded-2xl px-4 py-2">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="fbModal" class="hidden fixed inset-0 bg-black/50 z-50 p-4">
    <div class="bg-white w-full max-w-lg mx-auto mt-[10vh] rounded-2xl p-4">
      <div class="flex items-center justify-between mb-2">
        <div class="text-lg font-semibold">‡∏™‡πà‡∏á‡∏ü‡∏µ‡∏î‡πÅ‡∏ö‡πá‡∏Å</div>
        <button id="closeFb" class="px-3 py-1.5 rounded-xl hover:bg-gray-100">‚úï</button>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏´‡∏°?</label>
          <div class="mt-1 grid grid-cols-2 gap-2">
            <label class="border rounded-xl p-2 flex items-center gap-2"><input type="radio" name="fb_success" value="true" checked><span>‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span></label>
            <label class="border rounded-xl p-2 flex items-center gap-2"><input type="radio" name="fb_success" value="false"><span>‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span></label>
          </div>
        </div>
        <div>
          <label class="text-sm">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏ß‡∏°</label>
          <input id="fb_rating" type="range" min="1" max="5" step="1" value="4" class="w-full accent-blue-600" />
          <div class="text-xs text-gray-500">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <span id="fb_rating_label">4</span>/5</div>
        </div>
        <div>
          <label class="text-sm">‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏î‡∏µ/‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î? (‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ)</label>
          <textarea id="fb_comment" rows="4" class="w-full border rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠, ‡πÇ‡∏´‡∏ß‡∏ï‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏Ø‡∏•‡∏Ø"></textarea>
        </div>
        <div class="text-sm">
          <label class="inline-flex items-center gap-2"><input id="fb_consent" type="checkbox"> ‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö</label>
        </div>
        <div>
          <label class="text-sm">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ (‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡πÑ‡∏•‡∏ô‡πå - ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
          <input id="fb_contact" class="w-full border rounded-xl px-3 py-2" placeholder="example@email.com" />
        </div>
        <div class="text-xs text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠, ‡πÄ‡∏ß‡∏•‡∏≤, ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å</div>
        <div class="flex items-center justify-end gap-2">
          <button id="cancelFb" class="border rounded-2xl px-4 py-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="submitFb" class="bg-blue-600 hover:bg-blue-700 text-white rounded-2xl px-4 py-2">‡∏™‡πà‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- Optional endpoint (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ----
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Supabase / Form endpoint ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà URL ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    const FEEDBACK_ENDPOINT = null; // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "https://your-project.supabase.co/functions/v1/feedback"
    const FEEDBACK_METHOD = "POST";

    // ---------------------- Mock Data ----------------------
    const currentUser = { id:"u_me", name:"‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà", handle:"@tammy", level:"Explorer", points:520, badges:["Verified Explorer"] };
    const places = [
      { id:"p_khaotao", name:"‡∏≠‡πà‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏Ç‡∏≤‡πÄ‡∏ï‡πà‡∏≤", province:"‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", lat:12.5032, lng:99.9886, openingHours:"06:00‚Äì18:30", tags:["‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢","‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ","‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å"], rating:4.8, crowd:"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", photos:["https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop"] },
      { id:"p_somewhere_cnx", name:"Somewhere Cafe", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", category:"‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà", lat:18.7953, lng:98.9525, openingHours:"09:00‚Äì18:00", tags:["‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ß‡∏¥‡∏ß‡∏î‡∏µ","‡∏Å‡∏≤‡πÅ‡∏ü‡∏´‡∏≠‡∏°","‡∏†‡∏π‡πÄ‡∏Ç‡∏≤"], rating:4.5, crowd:"‡∏ô‡πâ‡∏≠‡∏¢", photos:["https://images.unsplash.com/photo-1498654896293-37aacf113fd9?q=80&w=1200&auto=format&fit=crop"] },
      { id:"p_monjam", name:"‡∏°‡πà‡∏≠‡∏ô‡πÅ‡∏à‡πà‡∏°", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", lat:18.9370, lng:98.8590, openingHours:"05:30‚Äì19:00", tags:["‡∏†‡∏π‡πÄ‡∏Ç‡∏≤","‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô","‡∏ß‡∏¥‡∏ß‡∏û‡∏≤‡πÇ‡∏ô‡∏£‡∏≤‡∏°‡∏≤"], rating:4.7, crowd:"‡∏°‡∏≤‡∏Å", photos:["https://images.unsplash.com/photo-1528821154947-1aa3d1b749b3?q=80&w=1200&auto=format&fit=crop"] },
      { id:"p_doisuthep", name:"‡∏î‡∏≠‡∏¢‡∏™‡∏∏‡πÄ‡∏ó‡∏û", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", category:"‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å", lat:18.8047, lng:98.9215, openingHours:"06:00‚Äì20:00", tags:["‡∏ß‡∏±‡∏î","‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß"], rating:4.6, crowd:"‡∏°‡∏≤‡∏Å", photos:["https://images.unsplash.com/photo-1548013146-72479768bada?q=80&w=1200&auto=format&fit=crop"] },
      { id:"p_bangsaen", name:"‡∏´‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô", province:"‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", category:"‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥", lat:13.2756, lng:100.9255, openingHours:"24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á", tags:["‡∏ó‡∏∞‡πÄ‡∏•","‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß","‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞"], rating:4.1, crowd:"‡∏°‡∏≤‡∏Å", photos:["https://images.unsplash.com/photo-1500375592092-40eb2168fd21?q=80&w=1200&auto=format&fit=crop"] },
    ];
    let reviews = [
      { id:"r1", placeId:"p_khaotao", user:"‡∏ô‡∏ô‡∏ó‡πå", userLevel:"Traveler", rating:5, text:"‡∏ß‡∏¥‡∏ß‡πÄ‡∏¢‡πá‡∏ô‡∏™‡∏ö‡∏≤‡∏¢ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å‡∏™‡∏ß‡∏¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÄ‡∏£‡πá‡∏ß ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏£‡∏¥‡∏°‡∏ó‡∏≤‡∏á", verifiedVisit:true, date:"2025-10-01", likes:22 },
      { id:"r2", placeId:"p_somewhere_cnx", user:"‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà", userLevel:"Explorer", rating:4, text:"‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏µ ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏´‡∏≠‡∏° ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏≤‡∏Å ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢", verifiedVisit:false, date:"2025-09-20", likes:18 },
      { id:"r3", placeId:"p_monjam", user:"‡∏û‡∏µ‡∏ó", userLevel:"Local Expert", rating:5, text:"‡∏•‡∏°‡πÄ‡∏¢‡πá‡∏ô ‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏õ‡πÄ‡∏ä‡πâ‡∏≤ ‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤", verifiedVisit:true, date:"2025-09-12", likes:34 },
      { id:"r4", placeId:"p_bangsaen", user:"‡∏ä‡∏¥‡∏ß", userLevel:"Traveler", rating:4, text:"‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î", verifiedVisit:false, date:"2025-08-30", likes:10 },
    ];
    const rewardsCatalog = [
      { id:"rw1", name:"‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î Grab 50 ‡∏ö‡∏≤‡∏ó", cost:300, desc:"‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" },
      { id:"rw2", name:"‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡∏ü‡∏£‡∏µ (Cafe Partner)", cost:500, desc:"‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" },
      { id:"rw3", name:"‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡πâ‡∏≤ TripMate", cost:800, desc:"‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ" },
    ];

    // ---------------------- State ----------------------
    let TAB="discover", MODE="posts", QUERY="", CAT="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", PROV="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", MAX_KM=80;
    let user = JSON.parse(JSON.stringify(currentUser));
    let userLoc = null;
    let lastDetailPlace = null;

    // ---------------------- Utils ----------------------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const setHidden = (el,hidden)=> el.classList.toggle("hidden", hidden);
    const kmDist=(a,b,c,d)=>{const R=6371,toRad=x=>x*Math.PI/180;const dLat=toRad(c-a),dLon=toRad(d-b);const A=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A))};
    const fmtKm=km=>km<1?(km*1000).toFixed(0)+" ‡∏°.":km.toFixed(1)+" ‡∏Å‡∏°.";
    const clip=(s,n)=>s.length>n?s.slice(0,n)+"‚Ä¶":s;
    const latestByPlace=()=>{const sorted=[...reviews].sort((a,b)=>a.date<b.date?1:-1);const m={};for(const r of sorted) if(!m[r.placeId]) m[r.placeId]=r;return m;}
    function filteredPlaces(){
      let arr=places.filter(p=>{const q=QUERY.trim().toLowerCase();const mq=!q||p.name.toLowerCase().includes(q)||p.tags.join(" ").toLowerCase().includes(q);const mc=CAT==="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"||p.category===CAT;const mp=PROV==="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"||p.province===PROV;return mq&&mc&&mp;});
      if(userLoc){arr=arr.map(p=>({p,d:kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)})).filter(({d})=>d<=MAX_KM).sort((a,b)=>a.d-b.d).map(({p})=>p);}else{arr=arr.sort((a,b)=>b.rating-a.rating);}
      return arr;
    }
    function openDetail(place){ lastDetailPlace = place; renderDetail(place); setHidden($("#detailModal"), false); }
    function closeDetail(){ setHidden($("#detailModal"), true); }
    function openCreate(){ populateCreatePlaces(); updateVerifyHint(); setHidden($("#createModal"), false); }
    function closeCreate(){ setHidden($("#createModal"), true); }

    // ---------------------- Renders ----------------------
    function renderNav(){ $$(".grid [data-tab]").forEach(btn=>{btn.classList.toggle("text-blue-600",btn.dataset.tab===TAB);btn.classList.toggle("text-gray-600",btn.dataset.tab!==TAB)}); setHidden($("#page-discover"),TAB!=="discover"); setHidden($("#page-search"),TAB!=="search"); setHidden($("#page-groups"),TAB!=="groups"); setHidden($("#page-rewards"),TAB!=="rewards"); setHidden($("#page-profile"),TAB!=="profile"); }
    function renderBanners(){ const banners=[{id:"bn1",title:"‡πÇ‡∏õ‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠",subtitle:"‡∏•‡∏î 10% ‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå",tag:"#CafeWeek",color:"bg-blue-50",emoji:"‚òï"},{id:"bn2",title:"‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°",subtitle:"‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏ß‡∏¢",tag:"#NatureNow",color:"bg-green-50",emoji:"üåø"},{id:"bn3",title:"#‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤",subtitle:"‡∏£‡∏ß‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà",tag:"#HiddenGems",color:"üìç",emoji:"üìç"}]; $("#promoBanners").innerHTML=banners.map(b=>`<div class="min-w-[260px] ${b.color} border rounded-2xl p-4"><div class="flex items-start justify-between"><div><div class="text-sm text-gray-600">üì£ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div><div class="font-semibold leading-tight">${b.title}</div><div class="text-xs text-gray-500">${b.subtitle}</div></div><div class="text-xl">${b.emoji}</div></div><div class="mt-2"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">${b.tag}</span></div></div>`).join(""); }
    function renderTopTags(){ const tags=["#‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ß‡∏¥‡∏ß‡∏î‡∏µ","#‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥","#‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß","#‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ","#‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏≠‡∏á","#‡∏ó‡∏∞‡πÄ‡∏•","#‡∏†‡∏π‡πÄ‡∏Ç‡∏≤"]; $("#topTags").innerHTML=tags.map(t=>`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border whitespace-nowrap">${t}</span>`).join(""); }
    function renderDiscover(){
      const container=$("#discoverContent");
      if(MODE==="posts"){
        const posts=[...reviews].map(r=>({...r,place:places.find(p=>p.id===r.placeId)})).sort((a,b)=>a.date<b.date?1:-1);
        container.innerHTML=posts.map(post=>`<div class="bg-white border rounded-2xl p-4"><div class="flex items-start gap-3"><img src="${post.place.photos[0]}" class="w-28 h-28 object-cover rounded-lg flex-shrink-0"/><div class="flex-1 min-w-0"><div class="flex items-center justify-between"><div class="font-semibold truncate">${post.place.name}</div><div class="text-amber-600 text-sm">‚≠ê ${post.rating}</div></div><div class="text-xs text-gray-500 truncate">${post.place.province} ¬∑ ${post.place.category}</div><p class="text-sm mt-2 line-clamp-3">${clip(post.text,160)}</p><div class="mt-2 flex items-center gap-2"><span class="text-xs text-gray-500">‚Äî ${post.user} ¬∑ ${post.userLevel||""}</span>${post.verifiedVisit?`<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] bg-gray-100">‚úîÔ∏é Verified Visitor</span>`:""}</div><div class="mt-3 flex items-center justify-between"><div class="flex items-center gap-2 text-xs text-gray-500"><span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border">#${post.place.tags[0]}</span><span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] border">#${post.place.tags[1]||"‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß"}</span></div><div class="flex items-center gap-2"><button class="border rounded-2xl px-3 py-1.5 text-sm" data-act="detail" data-id="${post.place.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button><button class="rounded-2xl px-3 py-1.5 text-sm bg-blue-600 text-white" data-act="share" data-text="‡∏£‡∏µ‡∏ß‡∏¥‡∏ß: ${post.place.name} ‡πÇ‡∏î‡∏¢ ${post.user}">‡πÅ‡∏ä‡∏£‡πå</button></div></div></div></div></div>`).join("");
      } else {
        const map=latestByPlace(); const arr=filteredPlaces();
        container.innerHTML=arr.map(p=>{const r=map[p.id]; const dist=userLoc?fmtKm(kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)):null; return `<div class="bg-white border rounded-2xl p-4 space-y-2"><div class="flex items-center justify-between"><div><div class="text-lg font-semibold">${p.name}</div><div class="text-sm text-gray-500">${p.province} ¬∑ ${p.category}</div></div><div class="flex items-center gap-2"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${p.rating.toFixed(1)}</span><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">Crowd: ${p.crowd}</span>${dist?`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">üìç ${dist}</span>`:""}</div></div>${r?`<div class="bg-gray-50 rounded-xl p-3"><div class="text-sm text-gray-700">‚Äú${clip(r.text,140)}‚Äù</div><div class="mt-1 flex items-center gap-2"><span class="text-xs text-gray-500">‚Äî ${r.user} ¬∑ ${r.userLevel||""}</span>${r.verifiedVisit?`<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] bg-gray-100">‚úîÔ∏é Verified Visitor</span>`:""}</div></div>`:""}<div class="flex flex-wrap gap-2">${p.tags.map(t=>`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">#${t}</span>`).join("")}</div><div class="flex items-center justify-between pt-1"><div class="text-xs text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ${p.openingHours}</div><div class="flex items-center gap-2"><button class="border rounded-2xl px-3 py-1.5 text-sm" data-act="detail" data-id="${p.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button><button class="rounded-2xl px-3 py-1.5 text-sm bg-blue-600 text-white" data-act="share" data-text="TripMate ¬∑ ${p.name} ¬∑ ${p.province}">‡πÅ‡∏ä‡∏£‡πå</button></div></div></div>`;}).join("");
      }
    }
    function renderSearchChips(){ const cats=["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î","‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà","‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥","‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å","‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£","‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å"]; $("#categoryChips").innerHTML=cats.map(c=>`<button class="px-3 py-1.5 rounded-2xl text-sm ${CAT===c?"bg-blue-600 text-white":"border"}" data-cat="${c}">${c}</button>`).join(""); const provs=["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",...Array.from(new Set(places.map(p=>p.province)))]; $("#provinceChips").innerHTML=provs.map(p=>`<button class="px-3 py-1.5 rounded-2xl text-sm ${PROV===p?"bg-blue-600 text-white":"border"}" data-prov="${p}">${p}</button>`).join(""); }
    function renderSearchResults(){ const arr=filteredPlaces(); const map=latestByPlace(); $("#searchResults").innerHTML=arr.length?arr.map(p=>{const r=map[p.id]; const dist=userLoc?fmtKm(kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)):null; return `<div class="bg-white border rounded-2xl p-4 space-y-2"><div class="flex items-center justify-between"><div><div class="text-lg font-semibold">${p.name}</div><div class="text-sm text-gray-500">${p.province} ¬∑ ${p.category}</div></div><div class="flex items-center gap-2"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${p.rating.toFixed(1)}</span><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">Crowd: ${p.crowd}</span>${dist?`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">üìç ${dist}</span>`:""}</div></div>${r?`<div class="bg-gray-50 rounded-xl p-3"><div class="text-sm text-gray-700">‚Äú${clip(r.text,140)}‚Äù</div><div class="mt-1 flex items-center gap-2"><span class="text-xs text-gray-500">‚Äî ${r.user} ¬∑ ${r.userLevel||""}</span>${r.verifiedVisit?`<span class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] bg-gray-100">‚úîÔ∏é Verified Visitor</span>`:""}</div></div>`:""}<div class="flex flex-wrap gap-2">${p.tags.map(t=>`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">#${t}</span>`).join("")}</div><div class="flex items-center justify-between pt-1"><div class="text-xs text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ${p.openingHours}</div><div class="flex items-center gap-2"><button class="border rounded-2xl px-3 py-1.5 text-sm" data-act="detail" data-id="${p.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button><button class="rounded-2xl px-3 py-1.5 text-sm bg-blue-600 text-white" data-act="share" data-text="TripMate ¬∑ ${p.name} ¬∑ ${p.province}">‡πÅ‡∏ä‡∏£‡πå</button></div></div></div>`;}).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p>`; }

    function renderGroups(){ const container=$("#groupContainer"); const existing=container.getAttribute("data-group")==="1"; if(!existing){ container.innerHTML=`<div class="bg-white border rounded-2xl p-4"><div class="flex items-center justify-between mb-2"><div class="text-lg font-semibold">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</div><button id="createGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-2xl px-3 py-1.5">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button></div><p class="text-sm text-gray-600">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÄ‡∏™‡∏ô‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏´‡∏ß‡∏ï ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î "‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ"</p></div><div id="groupArea" class="mt-3"></div>`; container.setAttribute("data-group","1"); $("#createGroupBtn").onclick=()=>{ const g={id:"g_"+Date.now(), name:"‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà 2025", members:["‡πÅ‡∏ó‡∏°‡∏°‡∏µ‡πà","‡∏ô‡∏ô‡∏ó‡πå","‡∏û‡∏µ‡∏ó","‡∏ä‡∏¥‡∏ß"], date:"2025-12-30", province:"‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", proposals:["p_monjam","p_somewhere_cnx","p_doisuthep"], votes:{}, confirmedPlaceIds:null}; container.dataset.gdata=JSON.stringify(g); drawGroup(g); }; } else if(container.dataset.gdata){ drawGroup(JSON.parse(container.dataset.gdata)); } }
    function drawGroup(g){ const area=$("#groupArea"); area.innerHTML=`<div class="bg-white border rounded-2xl p-4 flex items-center justify-between"><div><div class="text-lg font-semibold">${g.name}</div><div class="text-sm text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${g.members.join(", ")}</div></div><button class="border rounded-2xl px-3 py-1.5" onclick="navigator.clipboard.writeText('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°: ${g.name}')">‡πÅ‡∏ä‡∏£‡πå</button></div><div class="bg-white border rounded-2xl p-4 mt-3"><div class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</div>${g.proposals.map(pid=>{const p=places.find(x=>x.id===pid); const counts=Object.values(g.votes).filter(v=>v===pid).length; const voted=g.votes[currentUser.name]===pid; return `<div class="flex items-center justify-between border rounded-xl p-3 mb-2 ${voted?'border-blue-500':''}"><div><div class="font-medium">${p.name}</div><div class="text-xs text-gray-500">${p.province} ¬∑ ‚≠ê ${p.rating.toFixed(1)}</div></div><div class="flex items-center gap-3"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‡πÇ‡∏´‡∏ß‡∏ï: ${counts}</span><button class="px-3 py-1.5 rounded-2xl ${voted?'bg-blue-600 text-white':'border'}" data-vote="${pid}">${voted?'‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß':'‡πÇ‡∏´‡∏ß‡∏ï'}</button></div></div>`}).join("")}<div class="flex items-center justify-between pt-2"><div class="text-sm text-gray-500">‡∏Å‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Trip Plan</div><button id="confirmTripBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-2xl px-3 py-1.5">üó∫Ô∏è ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ</button></div></div><div id="tripSummary"></div>`; area.querySelectorAll("[data-vote]").forEach(btn=>{btn.addEventListener("click",()=>{g.votes[currentUser.name]=btn.getAttribute("data-vote"); document.querySelector("#groupContainer").dataset.gdata=JSON.stringify(g); drawGroup(g);});}); $("#confirmTripBtn").onclick=()=>{const counts={}; g.proposals.forEach(pid=>counts[pid]=0); Object.values(g.votes).forEach(pid=>counts[pid]=(counts[pid]||0)+1); const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,2).map(([pid])=>pid); g.confirmedPlaceIds=top; document.querySelector("#groupContainer").dataset.gdata=JSON.stringify(g); drawTripSummary(top); alert("‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß: ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß");}; }
    function drawTripSummary(ids){ const cont=$("#tripSummary"); cont.innerHTML=`<div class="bg-white border rounded-2xl p-4 mt-3"><div class="font-semibold mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏£‡∏¥‡∏õ (One-click Plan)</div>${ids.map(pid=>{const p=places.find(x=>x.id===pid); const map=latestByPlace(); const r=map[pid]; return `<div class="border rounded-2xl p-3 mb-2"><div class="flex items-center justify-between"><div><div class="font-medium">${p.name}</div><div class="text-xs text-gray-500">${p.province} ¬∑ ${p.category}</div></div><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${p.rating.toFixed(1)}</span></div>${r?`<div class="text-sm text-gray-600 mt-1">‚Äú${clip(r.text,120)}‚Äù ‚Äî ${r.user}</div>`:""}<div class="mt-2"><button class="border rounded-2xl px-3 py-1.5 text-sm" data-act="detail" data-id="${p.id}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></div></div>`}).join("")}<div class="flex items-center justify-end"><button class="border rounded-2xl px-3 py-1.5" onclick="navigator.clipboard.writeText('Trip Plan ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ä‡∏£‡πå')">‡πÅ‡∏ä‡∏£‡πå‡πÅ‡∏ú‡∏ô</button></div></div>`; }

    function renderRewards(){ $("#pointsEl").textContent=user.points+" pts"; $("#badgesEl").textContent="‡πÅ‡∏ö‡∏î‡∏à‡πå: "+(user.badges.join(", ")||"-"); $("#rewardsList").innerHTML=rewardsCatalog.map(rw=>`<div class="bg-white border rounded-2xl p-4 flex items-center justify-between"><div><div class="font-semibold">${rw.name}</div><div class="text-sm text-gray-500">${rw.desc}</div></div><div class="flex items-center gap-3"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">${rw.cost} pts</span><button class="bg-blue-600 hover:bg-blue-700 text-white rounded-2xl px-3 py-1.5" data-redeem="${rw.id}">‡πÅ‡∏•‡∏Å</button></div></div>`).join(""); $("#rewardsList").querySelectorAll("[data-redeem]").forEach(btn=>{btn.addEventListener("click",()=>{const rw=rewardsCatalog.find(r=>r.id===btn.getAttribute("data-redeem")); if(user.points<rw.cost){alert("‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡πÅ‡∏•‡∏Å");return;} user.points-=rw.cost; renderRewards(); renderProfileHeader(); alert(`‡πÅ‡∏•‡∏Å "${rw.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (mock)`);});}); }
    function renderProfileHeader(){ $("#userNameEl").textContent=user.name; $("#userHandleEl").textContent=user.handle; $("#userMetaEl").textContent=`‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${user.level} ¬∑ ‡πÅ‡∏ï‡πâ‡∏°: ${user.points} ¬∑ ‡πÅ‡∏ö‡∏î‡∏à‡πå: ${user.badges.join(", ")||"-"}`; const my=reviews.filter(r=>r.user===user.name); $("#myReviews").innerHTML=my.length?my.map(r=>{const p=places.find(x=>x.id===r.placeId); return `<div class="bg-white border rounded-2xl p-3"><div class="flex items-center justify-between"><div class="font-medium">${p.name}</div><div class="text-amber-600">‚≠ê ${r.rating}</div></div><p class="text-sm mt-1">${r.text}</p>${r.verifiedVisit?`<div class="mt-2"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‚úîÔ∏é Verified Visitor</span></div>`:""}</div>`;}).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>`; }

    function renderDetail(place){ const placeReviews=reviews.filter(r=>r.placeId===place.id).sort((a,b)=>a.date<b.date?1:-1); const autoNearby=places.filter(p=>p.id!==place.id).map(p=>({p,d:kmDist(place.lat,place.lng,p.lat,p.lng)})).filter(({d})=>d<=10).sort((a,b)=>a.d-b.d).map(({p})=>p); $("#detailContent").innerHTML=`<header class="space-y-1"><div class="text-xl font-semibold">${place.name}</div><div class="text-sm text-gray-500">${place.province} ¬∑ ${place.category}</div><div class="flex items-center gap-2 mt-1"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-blue-600 text-white">‚≠ê ${place.rating.toFixed(1)}</span><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">Crowd: ${place.crowd}</span><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs border">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£: ${place.openingHours}</span></div></header><section><div class="font-semibold mb-2">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="space-y-2">${placeReviews.length?placeReviews.map(r=>`<div class="border rounded-xl p-3"><div class="flex items-center justify-between"><div class="font-medium">${r.user} <span class="text-xs text-gray-500">¬∑ ${r.userLevel||""}</span></div><div class="text-amber-600">‚≠ê ${r.rating}</div></div><p class="text-sm mt-1">${r.text}</p>${r.verifiedVisit?`<div class="mt-2"><span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‚úîÔ∏é Verified Visitor</span></div>`:""}</div>`).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>`}</div></section><section><div class="font-semibold mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‚â§10 ‡∏Å‡∏°.)</div><div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${autoNearby.length?autoNearby.map(np=>`<div class="border rounded-xl p-3 flex items-center justify-between"><div><div class="font-medium">${np.name}</div><div class="text-xs text-gray-500">${np.category} ¬∑ ‚≠ê ${np.rating.toFixed(1)}</div></div><button class="px-3 py-1.5 rounded-2xl border" data-act="detail" data-id="${np.id}">‡∏î‡∏π</button></div>`).join(""):`<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ô‡∏µ‡πâ</p>`}</div></section><div class="flex items-center justify-end gap-2"><button class="px-3 py-1.5 rounded-2xl border" onclick="navigator.clipboard.writeText('Trip: ${place.name}')">‡πÅ‡∏ä‡∏£‡πå</button></div>`; }

    function populateCreatePlaces(){ $("#createPlace").innerHTML=places.map(p=>`<option value="${p.id}">${p.name} ¬∑ ${p.province}</option>`).join(""); }
    function updateVerifyHint(){ const pid=$("#createPlace").value||places[0].id; const p=places.find(x=>x.id===pid); const verified=userLoc?kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)<=1:false; $("#verifyHint").innerHTML=verified?`<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs bg-gray-100">‚úîÔ∏é Verified Visitor (GPS)</span>`:`* ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Verified`; }

    // ---------------------- Feedback logic ----------------------
    function openFb(){ $("#fb_rating_label").textContent = $("#fb_rating").value; setHidden($("#fbModal"), false); }
    function closeFb(){ setHidden($("#fbModal"), true); }

    $("#fb_rating").addEventListener("input", (e)=> $("#fb_rating_label").textContent = e.target.value );

    async function submitFeedback(){
      const success = document.querySelector('input[name="fb_success"]:checked')?.value === "true";
      const rating = Number($("#fb_rating").value);
      const comment = $("#fb_comment").value || "";
      const consent = $("#fb_consent").checked;
      const contact = $("#fb_contact").value || null;

      const context = {
        tab: TAB,
        place: lastDetailPlace ? { id: lastDetailPlace.id, name: lastDetailPlace.name, province: lastDetailPlace.province } : null
      };

      const payload = {
        created_at: new Date().toISOString(),
        rating_overall: rating,
        task_success: success,
        comment,
        consent_contact: consent,
        contact,
        context,
        device: navigator.platform || null,
        browser: navigator.userAgent
      };

      // Save to localStorage (append)
      const key = "tripmate_feedbacks";
      const existing = JSON.parse(localStorage.getItem(key) || "[]");
      existing.push(payload);
      localStorage.setItem(key, JSON.stringify(existing));

      // Optional POST
      if (FEEDBACK_ENDPOINT){
        try {
          await fetch(FEEDBACK_ENDPOINT, {
            method: FEEDBACK_METHOD || "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
        } catch (e) {
          console.warn("Feedback POST failed:", e);
        }
      }

      // Download JSON file as fallback
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type: "application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `feedback-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      alert("‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡∏î‡πÅ‡∏ö‡πá‡∏Å!");
      closeFb();
    }

    // ---------------------- Events ----------------------
    $$(".grid [data-tab]").forEach(btn=>{
      btn.onclick=()=>{ TAB=btn.dataset.tab; renderNav(); if(TAB==="discover"){renderDiscover()} if(TAB==="search"){renderSearchResults()} if(TAB==="groups"){renderGroups()} if(TAB==="rewards"){renderRewards()} if(TAB==="profile"){renderProfileHeader()} };
    });
    $("#discoverSearchInput").addEventListener("focus", ()=>{ TAB="search"; renderNav(); });
    $("#modePostsBtn").onclick=()=>{ MODE="posts"; $("#modePostsBtn").className="bg-blue-600 text-white rounded-2xl px-3 py-1.5 text-sm"; $("#modeTilesBtn").className="border rounded-2xl px-3 py-1.5 text-sm"; renderDiscover(); };
    $("#modeTilesBtn").onclick=()=>{ MODE="tiles"; $("#modeTilesBtn").className="bg-blue-600 text-white rounded-2xl px-3 py-1.5 text-sm"; $("#modePostsBtn").className="border rounded-2xl px-3 py-1.5 text-sm"; renderDiscover(); };
    document.body.addEventListener("click",(e)=>{const t=e.target.closest("[data-act]"); if(!t) return; const act=t.getAttribute("data-act"); if(act==="detail"){const id=t.getAttribute("data-id"); const p=places.find(x=>x.id===id); openDetail(p);} else if(act==="share"){const text=t.getAttribute("data-text")||"TripMate"; if(navigator.share){navigator.share({title:"TripMate", text});} else {navigator.clipboard.writeText(text); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß");}}});
    $("#closeDetail").onclick=closeDetail;
    $("#applySearchBtn").onclick=()=>{ QUERY=$("#searchInput").value||""; renderSearchResults(); };
    $("#searchInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ QUERY=$("#searchInput").value||""; renderSearchResults(); }});
    $("#distSlider").addEventListener("input",(e)=>{ MAX_KM=Number(e.target.value); $("#distVal").textContent=MAX_KM; renderSearchResults(); });
    $("#categoryChips").addEventListener("click",(e)=>{ const b=e.target.closest("[data-cat]"); if(!b) return; CAT=b.getAttribute("data-cat"); renderSearchChips(); renderSearchResults(); });
    $("#provinceChips").addEventListener("click",(e)=>{ const b=e.target.closest("[data-prov]"); if(!b) return; PROV=b.getAttribute("data-prov"); renderSearchChips(); renderSearchResults(); });
    $("#openCreatePost").onclick=openCreate; $("#closeCreate").onclick=closeCreate; $("#cancelCreate").onclick=closeCreate; $("#createPlace").addEventListener("change", updateVerifyHint); $("#createRate").addEventListener("input",(e)=>$("#createRateLabel").textContent=e.target.value); $("#submitCreate").onclick=()=>{ const placeId=$("#createPlace").value; const rating=Number($("#createRate").value); const text=$("#createText").value||"‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞"; const p=places.find(x=>x.id===placeId); const verified=userLoc?kmDist(userLoc.lat,userLoc.lng,p.lat,p.lng)<=1:false; const newReview={id:"r_"+Date.now(), placeId, user:user.name, userLevel:user.level, rating, text, verifiedVisit:verified, date:new Date().toISOString().slice(0,10), likes:0}; reviews=[newReview,...reviews]; user.points+=10+(verified?5:0); if(verified && !user.badges.includes("Verified Explorer")) user.badges.push("Verified Explorer"); alert(`‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πâ‡∏° ${10+(verified?5:0)}`); renderDiscover(); renderRewards(); renderProfileHeader(); closeCreate(); };

    // Feedback bindings
    $("#openFeedback").onclick = openFb;
    $("#closeFb").onclick = closeFb;
    $("#cancelFb").onclick = closeFb;
    $("#submitFb").onclick = submitFeedback;

    // ---------------------- Init ----------------------
    function renderSearchInit(){ renderSearchChips(); renderSearchResults(); }
    function init(){
      renderNav(); renderBanners(); renderTopTags(); renderDiscover(); renderSearchInit(); renderGroups(); renderRewards(); renderProfileHeader();
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition((pos)=>{
          userLoc={lat:pos.coords.latitude,lng:pos.coords.longitude};
          $("#locStatusEl").textContent="‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì"; $("#locInfo").textContent="‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏∏‡∏ì";
          renderDiscover(); renderSearchResults(); updateVerifyHint();
        }, ()=>{ $("#locStatusEl").textContent="‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"; $("#locInfo").textContent="‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏ó‡∏ô"; }, {enableHighAccuracy:true, timeout:7000});
      } else {
        $("#locStatusEl").textContent="‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
      }
    }
    init();
  </script>
</body>
</html>
